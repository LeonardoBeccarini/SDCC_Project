apiVersion: batch/v1
kind: Job
metadata:
  name: gateway-curl
  namespace: fog
spec:
  ttlSecondsAfterFinished: 60
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: curl
          image: curlimages/curl:8.9.1
          env:
            - name: GATEWAY_URL
              value: http://gateway.fog.svc.cluster.local:5009/dashboard/data
            - name: REQ_PER_SEC
              value: "2"
            - name: DURATION_SEC
              value: "30"
          command: ["sh","-lc"]
          args:
            - |
              echo "Hitting $GATEWAY_URL ($REQ_PER_SEC req/s for $DURATION_SEC s)"
              end=$(( $(date +%s) + DURATION_SEC ))
              c=0
              while [ $(date +%s) -lt $end ]; do
                for i in $(seq 1 $REQ_PER_SEC); do
                  code=$(curl -s -o /dev/null -w "%{http_code}" "$GATEWAY_URL" || echo 000)
                  echo "$(date +%H:%M:%S) -> $code"
                done
                sleep 1
              done
